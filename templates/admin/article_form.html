{% extends "layout.html" %}

{% block title %}–°—Ç–∞—Ç—Ç—è ‚Äî –í–ü–§–ö{% endblock %}

{% block content %}
  <section class="section">
    <div class="container admin-shell">
      <div class="admin-header">
        <div>
          <h1>{{ '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Å—Ç–∞—Ç—Ç—é' if article else '–ù–æ–≤–∞ —Å—Ç–∞—Ç—Ç—è' }}</h1>
          <p>–î–æ–¥–∞–≤–∞–π—Ç–µ –Ω–∞–∑–≤—É, –æ–ø–∏—Å, —Ç–µ–∫—Å—Ç —Ç–∞ –¥–∞—Ç–∏ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó.</p>
        </div>
        <a class="btn outline" href="{{ url_for('admin_articles') }}">–ù–∞–∑–∞–¥</a>
      </div>

      <div class="admin-card">
        <form method="post" enctype="multipart/form-data" class="form-grid">
          <label class="form-field">
            –ù–∞–∑–≤–∞
            <input class="input" name="title" type="text" value="{{ article.title if article else '' }}" required />
          </label>
          <label class="form-field">
            –ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å
            <textarea class="textarea" name="summary" rows="3">{{ article.summary if article else '' }}</textarea>
          </label>
          <div class="form-field">
            <div>–ü–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç</div>
            <div class="editor-toolbar" role="toolbar" aria-label="–§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É">
              <button class="btn outline small" type="button" data-cmd="bold"><b>B</b></button>
              <button class="btn outline small" type="button" data-cmd="italic"><i>I</i></button>
              <button class="btn outline small" type="button" data-cmd="underline"><u>U</u></button>
              <select class="select editor-select" data-cmd="fontName" aria-label="–®—Ä–∏—Ñ—Ç">
                <option value="Arial">Arial</option>
                <option value="Times New Roman">Times New Roman</option>
                <option value="Verdana">Verdana</option>
                <option value="Tahoma">Tahoma</option>
                <option value="Georgia">Georgia</option>
              </select>
              <select class="select editor-select" data-cmd="fontSize" aria-label="–†–æ–∑–º—ñ—Ä">
                <option value="2">–ú–∞–ª–∏–π</option>
                <option value="3" selected>–ù–æ—Ä–º–∞–ª—å–Ω–∏–π</option>
                <option value="4">–°–µ—Ä–µ–¥–Ω—ñ–π</option>
                <option value="5">–í–µ–ª–∏–∫–∏–π</option>
                <option value="6">–î—É–∂–µ –≤–µ–ª–∏–∫–∏–π</option>
              </select>
              <button class="btn outline small" type="button" id="insert-pdf-btn">–î–æ–¥–∞—Ç–∏ PDF</button>
              <input id="pdf-input" class="file-input" type="file" accept="application/pdf" />
            </div>
            <div
              id="content-editor"
              class="rich-editor"
              contenteditable="true"
              spellcheck="true"
              aria-label="–ü–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç"
              data-initial='{{ (article.content if article else "")|tojson }}'
            ></div>
            <textarea class="textarea" id="content-textarea" name="content" rows="6" style="display:none;"></textarea>
            <small>–ü–æ—Ä–∞–¥–∞: —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ—Ç—å—Å—è. PDF –¥–æ–¥–∞—î—Ç—å—Å—è —è–∫ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –≤ —Ç–µ–∫—Å—Ç.</small>
          </div>
          <label class="form-field">
            –ö–∞—Ç–µ–≥–æ—Ä—ñ—è
            <select class="select" name="category">
              {% for cat in categories %}
                <option value="{{ cat }}" {% if article and article.category == cat %}selected{% endif %}>
                  {{ cat }}
                </option>
              {% endfor %}
            </select>
          </label>
          <label class="form-field">
            –†–æ–∑–¥—ñ–ª —Å–∞–π—Ç—É
            <select class="select" name="section_id">
              <option value="">–ë–µ–∑ –ø—Ä–∏–≤'—è–∑–∫–∏</option>
              {% for section in sections %}
                <option value="{{ section.id }}" {% if article and article.section_id == section.id %}selected{% endif %}>
                  {{ "-" * section.level }} {{ section.title }}
                </option>
              {% endfor %}
            </select>
          </label>
          <label class="form-field">
            –î–∞—Ç–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó
            <input
              class="input"
              name="published_date"
              type="date"
              value="{{ article.published_date if article else '' }}"
            />
          </label>
          <label class="form-field">
            –î–∞—Ç–∞ –ø–æ–¥—ñ—ó (–¥–ª—è –ø–æ–¥—ñ–π)
            <input
              class="input"
              name="event_date"
              type="date"
              value="{{ article.event_date if article else '' }}"
            />
          </label>
          <label class="form-field">
            –ó–æ–≤–Ω—ñ—à–Ω—î –ø–æ—Å–∏–ª–∞–Ω–Ω—è (–∑–∞–º—ñ—Å—Ç—å —Å—Ç–∞—Ç—Ç—ñ –∞–±–æ —è–∫ –∫–Ω–æ–ø–∫–∞)
            <input
              class="input"
              name="external_link"
              type="url"
              placeholder="https://example.com"
              value="{{ article.external_link if article else '' }}"
            />
            <small>–Ø–∫—â–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ, —Å—Ç–∞—Ç—ñ—è –±—É–¥–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º –Ω–∞ —Ü–µ–π —Å–∞–π—Ç</small>
          </label>
          
          <!-- Featured Image Upload -->
          <div class="form-field">
            <div>–ì–æ–ª–æ–≤–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</div>
            <input type="hidden" name="remove_featured_image" id="remove-featured-image" value="0" />
            <div class="file-picker">
              <input
                id="featured-image-input"
                class="input file-input"
                type="file"
                name="featured_image"
                accept="image/*"
                onchange="handleFeaturedImageChange(event)"
              />
              <button class="btn outline" type="button" onclick="openFilePicker('featured-image-input')">
                –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ
              </button>
              <button class="btn outline danger small" type="button" onclick="clearFeaturedSelection()">
                –ü—Ä–∏–±—Ä–∞—Ç–∏ –≤–∏–±—ñ—Ä
              </button>
              {% if article and article.featured_image %}
                <button class="btn outline danger small" type="button" onclick="removeCurrentFeaturedImage()">
                  –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω–µ
                </button>
              {% endif %}
              <span id="featured-image-name" class="file-name" aria-live="polite"></span>
            </div>
            <div
              id="featured-preview"
              style="margin-top: 10px;"
              data-existing-url="{{ uploads_url(article.featured_image) if article and article.featured_image else '' }}"
            >
              {% if article and article.featured_image %}
                <img src="{{ uploads_url(article.featured_image) }}" style="max-width: 260px; max-height: 180px; object-fit: contain; background: #f8fafc; border-radius: 8px;" alt="Preview">
                <br><small>–ü–æ—Ç–æ—á–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</small>
              {% endif %}
            </div>
          </div>
          
          <!-- Gallery Images Upload -->
          <div class="form-field">
            <div>–ì–∞–ª–µ—Ä–µ—è –∑–æ–±—Ä–∞–∂–µ–Ω—å</div>
            <input type="hidden" name="remove_gallery_images" id="remove-gallery-images" value="[]" />
            <div class="file-picker">
              <input
                id="gallery-images-input"
                class="input file-input"
                type="file"
                name="gallery_images"
                accept="image/*"
                multiple
                onchange="handleGalleryImagesChange(event)"
              />
              <button class="btn outline" type="button" onclick="openFilePicker('gallery-images-input')">
                –î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ
              </button>
              <button class="btn outline danger small" type="button" onclick="clearGallerySelection()">
                –û—á–∏—Å—Ç–∏—Ç–∏ –≤–∏–±—ñ—Ä
              </button>
              <span id="gallery-images-name" class="file-name" aria-live="polite"></span>
            </div>
            <div id="gallery-preview" style="margin-top: 10px;">
              {% if article and article.image_gallery %}
                {% set gallery = article.image_gallery|from_json if article.image_gallery else [] %}
                <div class="gallery-grid" id="existing-gallery">
                  {% for img_path in gallery %}
                    <div class="gallery-item" data-gallery-path="{{ img_path }}">
                      <img src="{{ uploads_url(img_path) }}" style="max-width: 100px; max-height: 100px; object-fit: cover;" alt="Gallery {{ loop.index }}">
                      <button class="gallery-remove" type="button" onclick="markGalleryImageForRemoval(this)">√ó</button>
                    </div>
                  {% endfor %}
                </div>
                <br><small>–ü–æ—Ç–æ—á–Ω–∞ –≥–∞–ª–µ—Ä–µ—è</small>
              {% endif %}
            </div>
            <div id="gallery-new-preview" style="margin-top: 10px;"></div>
          </div>
          
          <button class="btn primary" type="submit">{{ '–ó–±–µ—Ä–µ–≥—Ç–∏' if article else '–°—Ç–≤–æ—Ä–∏—Ç–∏' }}</button>
        </form>
      </div>
    </div>
  </section>
{% endblock %}

{% block scripts %}
<script>
function openFilePicker(inputId) {
  const input = document.getElementById(inputId);
  if (input) input.click();
}

function initRichEditor() {
  const editor = document.getElementById('content-editor');
  const textarea = document.getElementById('content-textarea');
  const form = editor ? editor.closest('form') : null;
  if (!editor || !textarea || !form) return;

  const initial = editor.dataset.initial ? JSON.parse(editor.dataset.initial) : '';
  if (initial) {
    editor.innerHTML = initial;
  } else {
    editor.innerHTML = '';
  }

  function sync() {
    textarea.value = editor.innerHTML.trim();
  }

  form.addEventListener('submit', (e) => {
    sync();
    if (!textarea.value) {
      e.preventDefault();
      alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—Ç—ñ.');
      editor.focus();
    }
  });

  editor.addEventListener('input', sync);
  sync();

  // Toolbar handling
  document.querySelectorAll('.editor-toolbar button[data-cmd]').forEach((el) => {
    el.addEventListener('click', () => {
      const cmd = el.getAttribute('data-cmd');
      if (!cmd) return;
      document.execCommand(cmd, false, null);
      editor.focus();
      sync();
    });
  });
  document.querySelectorAll('.editor-toolbar select[data-cmd]').forEach((el) => {
    el.addEventListener('change', () => {
      const cmd = el.getAttribute('data-cmd');
      const value = el.value;
      document.execCommand(cmd, false, value);
      editor.focus();
      sync();
    });
  });

  // PDF insertion
  const pdfBtn = document.getElementById('insert-pdf-btn');
  const pdfInput = document.getElementById('pdf-input');
  if (pdfBtn && pdfInput) {
    pdfBtn.addEventListener('click', () => pdfInput.click());
    pdfInput.addEventListener('change', async () => {
      const file = pdfInput.files && pdfInput.files[0];
      if (!file) return;

      try {
        const formData = new FormData();
        formData.append('pdf', file);
        const res = await fetch('/admin/uploads/pdf', {
          method: 'POST',
          body: formData,
          credentials: 'same-origin',
        });
        const data = await res.json();
        if (!res.ok || !data.url) {
          throw new Error(data.error || 'Upload failed');
        }

        const safeName = (data.name || file.name || 'PDF').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const html = `<a href="${data.url}" target="_blank" rel="noopener">üìÑ ${safeName}</a>`;
        editor.focus();
        document.execCommand('insertHTML', false, html);
        sync();
      } catch (err) {
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF. ' + (err && err.message ? err.message : ''));
      } finally {
        pdfInput.value = '';
      }
    });
  }
}

function renderSelectedFiles(files, targetId) {
  const target = document.getElementById(targetId);
  if (!target) return;
  if (!files || files.length === 0) {
    target.textContent = '';
    return;
  }
  if (files.length === 1) {
    target.textContent = files[0].name;
    return;
  }
  target.textContent = `${files.length} —Ñ–∞–π–ª—ñ–≤`;
}

function clearFileInput(inputId) {
  const input = document.getElementById(inputId);
  if (input) input.value = '';
}

function restoreExistingFeaturedPreview() {
  const preview = document.getElementById('featured-preview');
  const removeFlag = document.getElementById('remove-featured-image');
  if (!preview) return;

  const existingUrl = preview.dataset.existingUrl || '';
  const isRemoved = removeFlag && removeFlag.value === '1';

  if (existingUrl && !isRemoved) {
    preview.innerHTML = `
      <img src="${existingUrl}" style="max-width: 260px; max-height: 180px; object-fit: contain; background: #f8fafc; border-radius: 8px;" alt="Preview">
      <br><small>–ü–æ—Ç–æ—á–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</small>
    `;
    return;
  }
  preview.innerHTML = '';
}

function clearFeaturedSelection() {
  clearFileInput('featured-image-input');
  renderSelectedFiles([], 'featured-image-name');
  const removeFlag = document.getElementById('remove-featured-image');
  if (removeFlag) removeFlag.value = '0';
  restoreExistingFeaturedPreview();
}

function removeCurrentFeaturedImage() {
  const removeFlag = document.getElementById('remove-featured-image');
  if (removeFlag) removeFlag.value = '1';
  clearFileInput('featured-image-input');
  renderSelectedFiles([], 'featured-image-name');
  const preview = document.getElementById('featured-preview');
  if (preview) {
    preview.innerHTML = '<small>–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±—É–¥–µ –≤–∏–¥–∞–ª–µ–Ω–æ –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.</small>';
  }
}

function handleFeaturedImageChange(event) {
  const removeFlag = document.getElementById('remove-featured-image');
  if (removeFlag) removeFlag.value = '0';
  renderSelectedFiles(event.target.files, 'featured-image-name');
  previewFeaturedImage(event);
}

function handleGalleryImagesChange(event) {
  renderSelectedFiles(event.target.files, 'gallery-images-name');
  previewGalleryImages(event);
}

function previewFeaturedImage(event) {
  const file = event.target.files[0];
  const preview = document.getElementById('featured-preview');
  
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.innerHTML = `
        <img src="${e.target.result}" style="max-width: 260px; max-height: 180px; object-fit: contain; background: #f8fafc; border-radius: 8px;" alt="Preview">
        <br><small>–ù–æ–≤–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</small>
      `;
    }
    reader.readAsDataURL(file);
  } else {
    restoreExistingFeaturedPreview();
  }
}

function previewGalleryImages(event) {
  const preview = document.getElementById('gallery-new-preview');
  if (!preview) return;

  const files = event.target.files ? Array.from(event.target.files) : [];
  preview.innerHTML = '';

  if (files.length === 0) return;

  files.forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.style.maxWidth = '100px';
      img.style.maxHeight = '100px';
      img.style.objectFit = 'cover';
      img.style.margin = '5px';
      img.alt = `Preview ${index + 1}`;
      preview.appendChild(img);
    };
    reader.readAsDataURL(file);
  });

  const br = document.createElement('br');
  const small = document.createElement('small');
  small.textContent = '–ù–æ–≤—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≥–∞–ª–µ—Ä–µ—ó';
  preview.appendChild(br);
  preview.appendChild(small);
}

function clearGallerySelection() {
  clearFileInput('gallery-images-input');
  renderSelectedFiles([], 'gallery-images-name');
  const newPreview = document.getElementById('gallery-new-preview');
  if (newPreview) newPreview.innerHTML = '';
}

function getRemoveGalleryList() {
  const input = document.getElementById('remove-gallery-images');
  if (!input) return [];
  try {
    const parsed = JSON.parse(input.value || '[]');
    return Array.isArray(parsed) ? parsed : [];
  } catch {
    return [];
  }
}

function setRemoveGalleryList(list) {
  const input = document.getElementById('remove-gallery-images');
  if (!input) return;
  input.value = JSON.stringify(list);
}

function markGalleryImageForRemoval(button) {
  const item = button.closest('[data-gallery-path]');
  if (!item) return;
  const path = item.getAttribute('data-gallery-path');
  if (!path) return;

  const list = getRemoveGalleryList();
  if (!list.includes(path)) list.push(path);
  setRemoveGalleryList(list);

  item.remove();
}

document.addEventListener('DOMContentLoaded', () => {
  initRichEditor();
});
</script>
{% endblock %}
