{% extends "layout.html" %}

{% block title %}Статті — ВПФК{% endblock %}

{% block content %}
  <section class="section">
    <div class="container">
      <div class="section-header">
        <h1>Статті</h1>
        {% if current_user %}
          <a class="link" href="{{ url_for('admin_articles') }}">Додати статтю</a>
        {% endif %}
      </div>

      <form class="filter-bar" method="get">
        <label class="filter-field">
          Категорія
          <select class="select" name="category">
            <option value="">Усі</option>
            {% for cat in categories %}
              <option value="{{ cat }}" {% if selected_category == cat %}selected{% endif %}>{{ cat }}</option>
            {% endfor %}
          </select>
        </label>
        <button class="btn outline" type="submit">Фільтрувати</button>
      </form>

      {% if articles %}
        <div class="article-list article-grid">
          {% for article in articles %}
            <article class="article-card">
              {% set thumb = article.featured_image %}
              {% if not thumb and article.image_gallery %}
                {% set gallery = article.image_gallery|from_json if article.image_gallery else [] %}
                {% if gallery %}
                  {% set thumb = gallery[0] %}
                {% endif %}
              {% endif %}
              {% if thumb %}
                <a class="article-thumb" href="{{ url_for('article_detail', article_id=article.id) }}">
                  <img src="{{ uploads_url(thumb) }}" alt="{{ article.title }}">
                </a>
              {% endif %}

              <div class="article-meta">
                <span class="badge">{{ article.category }}</span>
                <span class="muted">Публікація: {{ article.published_date }}</span>
                {% set author_name = article.author_full_name|trim if article.author_full_name else '' %}
                {% if article.author_username %}
                  <span class="muted">
                    Автор:
                    <a class="link" href="{{ url_for('user_profile', username=article.author_username) }}">{{ author_name or article.author_username }}</a>
                  </span>
                {% endif %}
                {% if article.event_date %}
                  <span class="muted">Подія: {{ article.event_date }}</span>
                {% endif %}
              </div>

              <h3>
                <a href="{{ url_for('article_detail', article_id=article.id) }}">{{ article.title }}</a>
              </h3>
              {% set summary_text = article.summary|clean_text %}
              {% if summary_text %}
                <p>{{ summary_text }}</p>
              {% endif %}
              <div class="article-footer">
                {% if article.section_title %}
                  <span class="muted">{{ article.section_title }}</span>
                {% endif %}
                <a class="link" href="{{ url_for('article_detail', article_id=article.id) }}">Читати</a>
              </div>
            </article>
          {% endfor %}
        </div>

        {% if total_pages > 1 %}
          <div class="pagination">
            {% for page_num in page_numbers %}
              <a
                class="page-link {% if page_num == current_page %}active{% endif %}"
                href="{{ url_for('articles', category=selected_category, page=page_num) }}"
              >
                {{ page_num }}
              </a>
            {% endfor %}
          </div>
        {% endif %}
      {% else %}
        <div class="empty-state">Поки що статей немає.</div>
      {% endif %}
    </div>
  </section>
{% endblock %}
